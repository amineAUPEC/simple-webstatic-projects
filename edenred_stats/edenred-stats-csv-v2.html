<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Dépenses Edenred</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 100%;
            overflow-x: hidden;
        }
        #fileDropArea {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
        }
        #dataInput {
            width: 100%;
            height: 150px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 15px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .chart-container {
            width: 100%;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        .filter-container {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
        }
        .filter-group {
            margin-bottom: 10px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
        }
        .filter-label {
            font-weight: bold;
            margin-right: 10px;
        }
        .filter-checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        .filter-checkbox-item {
            display: flex;
            align-items: center;
            white-space: nowrap;
        }
        .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
        }
        .stat-card {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            flex: 1;
            min-width: 200px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }
        @media (max-width: 768px) {
            .stat-card {
                flex-basis: 100%;
            }
        }
        .stat-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .stat-value {
            font-size: 24px;
            color: #007BFF;
        }
        .similar-amounts {
            margin-top: 20px;
            width: 100%;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .transaction-failed {
            background-color: #ffdddd;
        }
        .transaction-credit {
            background-color: #ddffdd;
        }
        .transaction-debit {
            background-color: #ffffff;
        }
        .tab-container {
            margin-bottom: 20px;
            width: 100%;
        }
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 5px 5px 0 0;
            display: flex;
            flex-wrap: wrap;
        }
        .tab button {
            background-color: inherit;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            color: black;
            flex: 1;
            min-width: 100px;
            text-align: center;
        }
        @media (max-width: 576px) {
            .tab button {
                flex-basis: 50%;
            }
        }
        .tab button:hover {
            background-color: #ddd;
        }
        .tab button.active {
            background-color: #007BFF;
            color: white;
        }
        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 5px 5px;
            width: 100%;
            box-sizing: border-box;
        }
        @media (max-width: 576px) {
            body {
                margin: 10px;
            }
            .tabcontent {
                padding: 10px;
            }
            h1 {
                font-size: 1.5rem;
            }
            h3 {
                font-size: 1.2rem;
            }
            table {
                font-size: 0.9rem;
            }
            th, td {
                padding: 4px;
            }
        }
        
        .mobile-notice {
            display: none;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .mobile-notice {
                display: block;
            }
        }
    </style>
</head>
<body>
    <h1>Dashboard Dépenses Edenred</h1>

    <div id="fileDropArea">
        <p>Glissez et déposez votre fichier CSV ici ou</p>
        <input type="file" id="fileInput" accept=".csv">
    </div>

    <h3>Ou collez vos données CSV ici :</h3>
    <textarea id="dataInput" placeholder="Coller les données CSV ici..."></textarea>

    <button id="processButton" onclick="processData()">Traiter les données</button>
    
    <div class="mobile-notice">
        <p><strong>Conseil:</strong> Pour une meilleure expérience sur mobile, tournez votre appareil en mode paysage.</p>
    </div>

    <div id="dashboard" style="display: none;">
        <!-- Onglets -->
        <div class="tab-container">
            <div class="tab">
                <button class="tablinks active" onclick="openTab(event, 'overview')">Vue d'ensemble</button>
                <button class="tablinks" onclick="openTab(event, 'transactions')">Transactions</button>
                <button class="tablinks" onclick="openTab(event, 'statistics')">Statistiques</button>
                <button class="tablinks" onclick="openTab(event, 'analysis')">Analyse</button>
            </div>

            <!-- Onglet Vue d'ensemble -->
            <div id="overview" class="tabcontent" style="display: block;">
                <div class="filter-container">
                    <h3>Filtres</h3>
                    <div class="filter-group">
                        <span class="filter-label">Période:</span>
                        <input type="date" id="overviewStartDate" onchange="applyOverviewFilters()">
                        <span>à</span>
                        <input type="date" id="overviewEndDate" onchange="applyOverviewFilters()">
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Type:</span>
                        <div class="filter-checkbox-group">
                            <div class="filter-checkbox-item">
                                <input type="checkbox" id="creditFilter" checked onchange="applyFilters()">
                                <label for="creditFilter">Crédit</label>
                            </div>
                            <div class="filter-checkbox-item">
                                <input type="checkbox" id="debitFilter" checked onchange="applyFilters()">
                                <label for="debitFilter">Débit</label>
                            </div>
                            <div class="filter-checkbox-item">
                                <input type="checkbox" id="failedFilter" checked onchange="applyFilters()">
                                <label for="failedFilter">Transactions échouées</label>
                            </div>
                            <div class="filter-checkbox-item">
                                <input type="checkbox" id="loadingFilter" checked onchange="applyFilters()">
                                <label for="loadingFilter">Chargements</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-title">Total Crédit</div>
                        <div id="totalCredit" class="stat-value">0 €</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Total Débit</div>
                        <div id="totalDebit" class="stat-value">0 €</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Solde</div>
                        <div id="balance" class="stat-value">0 €</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Transactions échouées</div>
                        <div id="failedCount" class="stat-value">0</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>Crédit vs Débit par mois</h3>
                    <canvas id="monthlyBalanceChart"></canvas>
                </div>

                <div class="chart-container">
                    <h3>Dépenses par semaine</h3>
                    <canvas id="weeklySpendingChart"></canvas>
                </div>

                <div class="chart-container">
                    <h3>Dépenses par restaurant</h3>
                    <canvas id="restaurantSpendingChart"></canvas>
                </div>
            </div>

            <!-- Onglet Transactions -->
            <div id="transactions" class="tabcontent">
                <div class="filter-container">
                    <h3>Filtres des transactions</h3>
                    <div class="filter-group">
                        <span class="filter-label">Recherche:</span>
                        <input type="text" id="searchFilter" placeholder="Rechercher..." onkeyup="applyFilters()">
                    </div>
                </div>
                <table id="transactionsTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Statut</th>
                            <th>Montant</th>
                            <th>Détails</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsBody">
                        <!-- Données ajoutées dynamiquement -->
                    </tbody>
                </table>
            </div>

            <!-- Onglet Statistiques -->
            <div id="statistics" class="tabcontent">
                <div class="chart-container">
                    <h3>Dépenses par sous-semaine</h3>
                    <canvas id="subWeeklySpendingChart"></canvas>
                </div>

                <div class="chart-container">
                    <h3>Répartition des dépenses par jour de la semaine</h3>
                    <canvas id="weekdaySpendingChart"></canvas>
                </div>

                <div class="chart-container">
                    <h3>Évolution des chargements</h3>
                    <canvas id="loadingChart"></canvas>
                </div>
            </div>

            <!-- Onglet Analyse -->
            <div id="analysis" class="tabcontent">
                <div class="similar-amounts">
                    <h3>Montants similaires</h3>
                    <div id="similarAmounts">
                        <!-- Données ajoutées dynamiquement -->
                    </div>
                </div>

                <div class="similar-amounts">
                    <h3>Montants fréquents</h3>
                    <div id="frequentAmounts">
                        <!-- Données ajoutées dynamiquement -->
                    </div>
                </div>

                <div class="similar-amounts">
                    <h3>Jours sans transaction</h3>
                    <div id="emptyDays">
                        <!-- Données ajoutées dynamiquement -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales pour stocker les données
        let allTransactions = [];
        let creditData = {};
        let debitData = {};
        let failedTransactions = [];
        let loadingTransactions = [];
        let monthlyBalanceData = {};
        let weeklySpendingData = {};
        let subWeeklySpendingData = {};
        let weekdaySpendingData = {};
        let restaurantSpendingData = {};
        let loadingData = {};
        let charts = {};

        // Fonction pour traiter les données
        function processData() {
            const fileInput = document.getElementById('fileInput');
            const dataInput = document.getElementById('dataInput').value;

            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        analyzeData(results.data);
                        // Initialiser les filtres après le chargement des données
                        initializeFilters();
                    }
                });
            } else if (dataInput.trim() !== '') {
                const results = Papa.parse(dataInput, {
                    header: true,
                    skipEmptyLines: true
                });
                analyzeData(results.data);
                // Initialiser les filtres après le chargement des données
                initializeFilters();
            } else {
                alert('Veuillez téléverser un fichier CSV ou coller des données CSV.');
            }
        }
        
        // Fonction pour initialiser les filtres après le chargement des données
        function initializeFilters() {
            // Appliquer les filtres initiaux pour chaque onglet
            applyFilters();
            applyOverviewFilters();
            
            // S'assurer que les filtres sont correctement configurés
            document.getElementById('creditFilter').checked = true;
            document.getElementById('debitFilter').checked = true;
            document.getElementById('failedFilter').checked = true;
            document.getElementById('loadingFilter').checked = true;
        }

        // Fonction pour analyser les données
        function analyzeData(data) {
            // Réinitialiser les données
            allTransactions = [];
            creditData = {};
            debitData = {};
            failedTransactions = [];
            loadingTransactions = [];
            monthlyBalanceData = {};
            weeklySpendingData = {};
            subWeeklySpendingData = {};
            weekdaySpendingData = { "Lundi": 0, "Mardi": 0, "Mercredi": 0, "Jeudi": 0, "Vendredi": 0, "Samedi": 0, "Dimanche": 0 };
            restaurantSpendingData = {};
            loadingData = {};

            // Traiter chaque transaction
            data.forEach(row => {
                // Convertir la date au format français (JJ/MM/AAAA) en objet Date
                const dateParts = row['Date'].split('/');
                const date = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                
                // Formater les informations de la transaction
                const transaction = {
                    date: date,
                    dateStr: row['Date'],
                    type: row['Type'],
                    status: row['Statut'],
                    amount: parseFloat(row['Montant'].replace(',', '.').replace(' €', '')),
                    details: row['Détails']
                };
                
                allTransactions.push(transaction);
                
                // Déterminer le mois et la semaine
                const month = date.toLocaleString('fr-FR', { month: 'long', year: 'numeric' });
                const weekOfMonth = Math.ceil(date.getDate() / 7);
                const week = `Semaine ${weekOfMonth}`;
                const subWeek = `${month} - ${week}`;
                const weekday = date.toLocaleString('fr-FR', { weekday: 'long' });
                
                // Initialiser les structures de données si nécessaire
                if (!monthlyBalanceData[month]) {
                    monthlyBalanceData[month] = { credit: 0, debit: 0 };
                }
                
                if (!weeklySpendingData[week]) {
                    weeklySpendingData[week] = 0;
                }
                
                if (!subWeeklySpendingData[subWeek]) {
                    subWeeklySpendingData[subWeek] = 0;
                }
                
                // Traiter selon le type de transaction
                if (transaction.type === 'Crédit') {
                    // Gérer les crédits
                    if (!creditData[month]) {
                        creditData[month] = 0;
                    }
                    creditData[month] += transaction.amount;
                    monthlyBalanceData[month].credit += transaction.amount;
                    
                    // Identifier les chargements (montants importants)
                    if (transaction.status === 'Succès' && transaction.details.includes('Chargement')) {
                        loadingTransactions.push(transaction);
                        
                        // Enregistrer les données de chargement
                        if (!loadingData[month]) {
                            loadingData[month] = 0;
                        }
                        loadingData[month] += transaction.amount;
                    }
                } else if (transaction.type === 'Débit') {
                    // Gérer les débits
                    if (transaction.status === 'Echec') {
                        // Transaction échouée
                        failedTransactions.push(transaction);
                    } else {
                        // Débit normal
                        if (!debitData[month]) {
                            debitData[month] = 0;
                        }
                        debitData[month] += transaction.amount;
                        monthlyBalanceData[month].debit += transaction.amount;
                        
                        // Mise à jour des données hebdomadaires et sous-hebdomadaires
                        weeklySpendingData[week] += transaction.amount;
                        subWeeklySpendingData[subWeek] += transaction.amount;
                        weekdaySpendingData[weekday] += transaction.amount;
                        
                        // Mise à jour des données des restaurants
                        const restaurant = transaction.details.split('-')[0].trim();
                        if (!restaurantSpendingData[restaurant]) {
                            restaurantSpendingData[restaurant] = 0;
                        }
                        restaurantSpendingData[restaurant] += transaction.amount;
                    }
                }
            });
            
            // Afficher le dashboard
            document.getElementById('dashboard').style.display = 'block';
            
            // Mettre à jour les statistiques et les graphiques
            updateStatistics();
            updateTransactionsTable();
            displayCharts();
            analyzeSimilarAmounts();
            findEmptyDays();
        }
        
        // Fonction pour mettre à jour les statistiques
        function updateStatistics() {
            let totalCredit = 0;
            let totalDebit = 0;
            
            Object.values(creditData).forEach(amount => {
                totalCredit += amount;
            });
            
            Object.values(debitData).forEach(amount => {
                totalDebit += amount;
            });
            
            document.getElementById('totalCredit').textContent = totalCredit.toFixed(2) + ' €';
            document.getElementById('totalDebit').textContent = totalDebit.toFixed(2) + ' €';
            document.getElementById('balance').textContent = (totalCredit - totalDebit).toFixed(2) + ' €';
            document.getElementById('failedCount').textContent = failedTransactions.length;
        }
        
        // Fonction pour mettre à jour le tableau des transactions
        function updateTransactionsTable() {
            const tbody = document.getElementById('transactionsBody');
            tbody.innerHTML = '';
            
            allTransactions.sort((a, b) => b.date - a.date).forEach(transaction => {
                const row = document.createElement('tr');
                
                // Appliquer une classe selon le type de transaction
                if (transaction.status === 'Echec') {
                    row.classList.add('transaction-failed');
                } else if (transaction.type === 'Crédit') {
                    row.classList.add('transaction-credit');
                } else {
                    row.classList.add('transaction-debit');
                }
                
                row.innerHTML = `
                    <td>${transaction.dateStr}</td>
                    <td>${transaction.type}</td>
                    <td>${transaction.status}</td>
                    <td>${transaction.amount.toFixed(2)} €</td>
                    <td>${transaction.details}</td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // Fonction pour afficher les graphiques
        function displayCharts() {
            // Graphique Crédit vs Débit par mois
            displayMonthlyBalanceChart();
            
            // Graphique des dépenses hebdomadaires
            displayWeeklySpendingChart();
            
            // Graphique des dépenses par restaurant
            displayRestaurantSpendingChart();
            
            // Graphique des dépenses par sous-semaine
            displaySubWeeklySpendingChart();
            
            // Graphique des dépenses par jour de la semaine
            displayWeekdaySpendingChart();
            
            // Graphique des chargements
            displayLoadingChart();
        }
        
        // Fonction pour afficher le graphique des soldes mensuels
        function displayMonthlyBalanceChart() {
            const ctx = document.getElementById('monthlyBalanceChart').getContext('2d');
            
            if (charts.monthlyBalance) {
                charts.monthlyBalance.destroy();
            }
            
            const months = Object.keys(monthlyBalanceData);
            const creditValues = months.map(month => monthlyBalanceData[month].credit);
            const debitValues = months.map(month => monthlyBalanceData[month].debit);
            
            charts.monthlyBalance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Crédit',
                            data: creditValues,
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Débit',
                            data: debitValues,
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Fonction pour afficher le graphique des dépenses hebdomadaires
        function displayWeeklySpendingChart() {
            const ctx = document.getElementById('weeklySpendingChart').getContext('2d');
            
            if (charts.weeklySpending) {
                charts.weeklySpending.destroy();
            }
            
            charts.weeklySpending = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(weeklySpendingData),
                    datasets: [{
                        label: 'Dépenses hebdomadaires',
                        data: Object.values(weeklySpendingData),
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1,
                        tension: 0.1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Fonction pour afficher le graphique des dépenses par restaurant
        function displayRestaurantSpendingChart() {
            const ctx = document.getElementById('restaurantSpendingChart').getContext('2d');
            
            if (charts.restaurantSpending) {
                charts.restaurantSpending.destroy();
            }
            
            // Trier les restaurants par montant dépensé (décroissant)
            const sortedRestaurants = Object.entries(restaurantSpendingData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10); // Limiter aux 10 premiers restaurants
            
            const labels = sortedRestaurants.map(item => item[0]);
            const data = sortedRestaurants.map(item => item[1]);
            
            charts.restaurantSpending = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Dépenses par restaurant',
                        data: data,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.5)',
                            'rgba(54, 162, 235, 0.5)',
                            'rgba(255, 206, 86, 0.5)',
                            'rgba(75, 192, 192, 0.5)',
                            'rgba(153, 102, 255, 0.5)',
                            'rgba(255, 159, 64, 0.5)',
                            'rgba(201, 203, 207, 0.5)',
                            'rgba(255, 99, 71, 0.5)',
                            'rgba(50, 205, 50, 0.5)',
                            'rgba(0, 191, 255, 0.5)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(201, 203, 207, 1)',
                            'rgba(255, 99, 71, 1)',
                            'rgba(50, 205, 50, 1)',
                            'rgba(0, 191, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                }
            });
        }
        
        // Fonction pour afficher le graphique des dépenses par sous-semaine
        function displaySubWeeklySpendingChart() {
            const ctx = document.getElementById('subWeeklySpendingChart').getContext('2d');
            
            if (charts.subWeeklySpending) {
                charts.subWeeklySpending.destroy();
            }
            
            charts.subWeeklySpending = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(subWeeklySpendingData),
                    datasets: [{
                        label: 'Dépenses par sous-semaine',
                        data: Object.values(subWeeklySpendingData),
                        backgroundColor: 'rgba(153, 102, 255, 0.5)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Fonction pour afficher le graphique des dépenses par jour de la semaine
        function displayWeekdaySpendingChart() {
            const ctx = document.getElementById('weekdaySpendingChart').getContext('2d');
            
            if (charts.weekdaySpending) {
                charts.weekdaySpending.destroy();
            }
            
            // Ordre des jours de la semaine
            const weekdays = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"];
            const data = weekdays.map(day => weekdaySpendingData[day] || 0);
            
            charts.weekdaySpending = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: weekdays,
                    datasets: [{
                        label: 'Dépenses par jour',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        pointBackgroundColor: 'rgba(54, 162, 235, 1)'
                    }]
                },
                options: {
                    scales: {
                        r: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Fonction pour afficher le graphique des chargements
        function displayLoadingChart() {
            const ctx = document.getElementById('loadingChart').getContext('2d');
            
            if (charts.loading) {
                charts.loading.destroy();
            }
            
            charts.loading = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(loadingData),
                    datasets: [{
                        label: 'Montant des chargements',
                        data: Object.values(loadingData),
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Fonction pour analyser les montants similaires
        function analyzeSimilarAmounts() {
            // Regrouper les transactions par montant
            const amountGroups = {};
            
            allTransactions.forEach(transaction => {
                if (transaction.type === 'Débit' && transaction.status !== 'Echec') {
                    const amount = transaction.amount.toFixed(2);
                    if (!amountGroups[amount]) {
                        amountGroups[amount] = [];
                    }
                    amountGroups[amount].push(transaction);
                }
            });
            
            // Trouver les montants qui apparaissent plusieurs fois
            const similarAmountsDiv = document.getElementById('similarAmounts');
            similarAmountsDiv.innerHTML = '';
            
            const similarAmounts = Object.entries(amountGroups)
                .filter(([_, transactions]) => transactions.length > 1)
                .sort((a, b) => b[1].length - a[1].length);
            
            if (similarAmounts.length === 0) {
                similarAmountsDiv.innerHTML = '<p>Aucun montant similaire trouvé.</p>';
                return;
            }
            
            // Créer un tableau pour afficher les montants similaires
            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Montant</th>
                        <th>Nombre d'occurrences</th>
                        <th>Détails</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            `;
            
            const tbody = table.querySelector('tbody');
            
            similarAmounts.forEach(([amount, transactions]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${amount} €</td>
                    <td>${transactions.length}</td>
                    <td>${transactions.map(t => `${t.dateStr}: ${t.details}`).join('<br>')}</td>
                `;
                tbody.appendChild(row);
            });
            
            similarAmountsDiv.appendChild(table);
            
            // Afficher les montants fréquents
            const frequentAmountsDiv = document.getElementById('frequentAmounts');
            frequentAmountsDiv.innerHTML = '';
            
            // Créer un graphique pour les montants fréquents
            const canvas = document.createElement('canvas');
            frequentAmountsDiv.appendChild(canvas);
            
            const top5Amounts = similarAmounts.slice(0, 5);
            
            new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: top5Amounts.map(([amount, _]) => `${amount} €`),
                    datasets: [{
                        label: 'Fréquence des montants',
                        data: top5Amounts.map(([_, transactions]) => transactions.length),
                        backgroundColor: 'rgba(255, 159, 64, 0.5)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        // Fonction pour trouver les jours sans transaction
        function findEmptyDays() {
            if (allTransactions.length === 0) return;
            
            // Trier les transactions par date
            const sortedTransactions = [...allTransactions].sort((a, b) => a.date - b.date);
            
            // Trouver la première et la dernière date
            const firstDate = sortedTransactions[0].date;
            const lastDate = sortedTransactions[sortedTransactions.length - 1].date;
            
            // Créer un ensemble de toutes les dates avec des transactions
            const datesWithTransactions = new Set();
            sortedTransactions.forEach(transaction => {
                datesWithTransactions.add(transaction.dateStr);
            });
            
            // Trouver les jours sans transaction
            const emptyDays = [];
            const currentDate = new Date(firstDate);
            
            while (currentDate <= lastDate) {
                const dateStr = currentDate.toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                }).replace(/\//g, '/');
                
                if (!datesWithTransactions.has(dateStr)) {
                    // Vérifier si c'est un jour de semaine (lundi-vendredi)
                    const dayOfWeek = currentDate.getDay();
                    if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                        emptyDays.push(dateStr);
                    }
                }
                
                // Passer au jour suivant
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Afficher les jours sans transaction
            const emptyDaysDiv = document.getElementById('emptyDays');
            emptyDaysDiv.innerHTML = '';
            
            if (emptyDays.length === 0) {
                emptyDaysDiv.innerHTML = '<p>Aucun jour ouvré sans transaction trouvé.</p>';
                return;
            }
            
            const p = document.createElement('p');
            p.textContent = `${emptyDays.length} jours ouvrés sans transaction trouvés:`;
            emptyDaysDiv.appendChild(p);
            
            const ul = document.createElement('ul');
            emptyDays.forEach(day => {
                const li = document.createElement('li');
                li.textContent = day;
                ul.appendChild(li);
            });
            
            emptyDaysDiv.appendChild(ul);
        }
        
        // Fonction pour appliquer les filtres
        function applyFilters() {
            const creditFilter = document.getElementById('creditFilter').checked;
            const debitFilter = document.getElementById('debitFilter').checked;
            const failedFilter = document.getElementById('failedFilter').checked;
            const loadingFilter = document.getElementById('loadingFilter').checked;
            const searchFilter = document.getElementById('searchFilter') ? document.getElementById('searchFilter').value.toLowerCase() : '';
            
            // Filtrer les transactions
            const filteredTransactions = allTransactions.filter(transaction => {
                // Filtre de type - logique améliorée
                let typeMatch = false;
                
                if (transaction.type === 'Crédit') {
                    if (transaction.details.includes('Chargement')) {
                        // C'est un chargement
                        typeMatch = creditFilter && loadingFilter;
                    } else {
                        // C'est un crédit normal
                        typeMatch = creditFilter;
                    }
                } else if (transaction.type === 'Débit') {
                    if (transaction.status === 'Echec') {
                        // C'est une transaction échouée
                        typeMatch = failedFilter;
                    } else {
                        // C'est un débit normal
                        typeMatch = debitFilter;
                    }
                }
                
                if (!typeMatch) return false;
                
                // Filtre de recherche
                if (searchFilter && !transaction.details.toLowerCase().includes(searchFilter)) {
                    return false;
                }
                
                return true;
            });
            
            // Mettre à jour le tableau des transactions
            const tbody = document.getElementById('transactionsBody');
            tbody.innerHTML = '';
            
            filteredTransactions.sort((a, b) => b.date - a.date).forEach(transaction => {
                const row = document.createElement('tr');
                
                // Appliquer une classe selon le type de transaction
                if (transaction.status === 'Echec') {
                    row.classList.add('transaction-failed');
                } else if (transaction.type === 'Crédit') {
                    row.classList.add('transaction-credit');
                } else {
                    row.classList.add('transaction-debit');
                }
                
                row.innerHTML = `
                    <td>${transaction.dateStr}</td>
                    <td>${transaction.type}</td>
                    <td>${transaction.status}</td>
                    <td>${transaction.amount.toFixed(2)} €</td>
                    <td>${transaction.details}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Mettre à jour les statistiques pour refléter les données filtrées
            updateFilteredStatistics(filteredTransactions);
        }
        
        // Fonction pour appliquer les filtres de la vue d'ensemble
        function applyOverviewFilters() {
            const startDate = document.getElementById('overviewStartDate').value;
            const endDate = document.getElementById('overviewEndDate').value;
            
            // Filtrer les transactions par date
            const filteredTransactions = allTransactions.filter(transaction => {
                const date = transaction.date;
                return (!startDate || date >= new Date(startDate)) && (!endDate || date <= new Date(endDate));
            });
            
            // Mettre à jour les statistiques
            updateFilteredStatistics(filteredTransactions);
        }
        
        // Fonction pour mettre à jour les statistiques basées sur les données filtrées
        function updateFilteredStatistics(filteredTransactions) {
            let totalCredit = 0;
            let totalDebit = 0;
            let failedCount = 0;
            
            filteredTransactions.forEach(transaction => {
                if (transaction.type === 'Crédit' && transaction.status !== 'Echec') {
                    totalCredit += transaction.amount;
                } else if (transaction.type === 'Débit' && transaction.status !== 'Echec') {
                    totalDebit += transaction.amount;
                } else if (transaction.status === 'Echec') {
                    failedCount++;
                }
            });
            
            document.getElementById('totalCredit').textContent = totalCredit.toFixed(2) + ' €';
            document.getElementById('totalDebit').textContent = totalDebit.toFixed(2) + ' €';
            document.getElementById('balance').textContent = (totalCredit - totalDebit).toFixed(2) + ' €';
            document.getElementById('failedCount').textContent = failedCount;
        }
        
        // Fonction pour ouvrir un onglet
        function openTab(evt, tabName) {
            // Masquer tous les contenus d'onglet
            const tabcontent = document.getElementsByClassName('tabcontent');
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = 'none';
            }
            
            // Désactiver tous les boutons d'onglet
            const tablinks = document.getElementsByClassName('tablinks');
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(' active', '');
            }
            
            // Afficher le contenu de l'onglet sélectionné et activer le bouton
            document.getElementById(tabName).style.display = 'block';
            evt.currentTarget.className += ' active';
        }
    </script>
</body>
</html>
